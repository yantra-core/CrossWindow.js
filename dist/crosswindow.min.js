!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).CW=e()}(function(){return function i(o,r,a){function s(t,e){if(!r[t]){if(!o[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(c)return c(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=r[t]={exports:{}},o[t][0].call(n.exports,function(e){return s(o[t][1][e]||e)},n,n.exports,i,o,r,a)}return r[t].exports}for(var c="function"==typeof require&&require,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),Object.defineProperty(n,"CrossWindow",{enumerable:!0,get:function(){return i.default}}),n.createCrossWindow=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return new i.default(e)};var i=(n=e("./lib/CrossWindow.js"))&&n.__esModule?n:{default:n}},{"./lib/CrossWindow.js":2}],2:[function(e,t,n){"use strict";function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(t,e){var n,i=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)),i}function a(i){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?r(Object(o),!0).forEach(function(e){var t,n;t=i,n=o[e=e],(e=u(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(o)):r(Object(o)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(o,e))})}return i}function s(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,o,r,a,s=[],c=!0,u=!1;try{if(r=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(i=r.call(n)).done)&&(s.push(i.value),s.length!==t);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(u)throw o}}return s}}(e,t)||function(e,t){var n;if(e)return"string"==typeof e?o(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,u(i.key),i)}}function u(e){e=function(e,t){if("object"!=i(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0===n)return("string"===t?String:Number)(e);n=n.call(e,t||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==i(e)?e:String(e)}Object.defineProperty(n,"__esModule",{value:!0}),n.default=void 0;n.default=function(){function o(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"windowMetadata",n=this,i=o;if(!(n instanceof i))throw new TypeError("Cannot call a class as a function");this.game=e,this.metadataKey=t,this.windowId=this.generateWindowId(),this.channel=new BroadcastChannel("crosswindow_channel"),this.events={},this.setupListeners(),this.registerWindow(),this.startMetadataPolling()}var e,t,n;return e=o,(t=[{key:"generateWindowId",value:function(){return"".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9))}},{key:"startMetadataPolling",value:function(){var t=this;this.prevMetadata=this.getWindowMetadata(),setInterval(function(){var e=t.getWindowMetadata();t.hasMetadataChanged(t.prevMetadata,e)&&(t.updateWindowMetadata(e),t.checkForIntersections(e))},100)}},{key:"getWindowMetadata",value:function(){return{position:{x:window.screenX,y:window.screenY},size:{width:window.innerWidth,height:window.innerHeight}}}},{key:"hasMetadataChanged",value:function(e,t){return e.position.x!==t.position.x||e.position.y!==t.position.y||e.size.width!==t.size.width||e.size.height!==t.size.height}},{key:"updateWindowMetadata",value:function(){var e={position:{x:window.screenX,y:window.screenY},size:{width:window.innerWidth,height:window.innerHeight},lastActive:Date.now()},t=JSON.parse(localStorage.getItem(this.metadataKey))||{};t[this.windowId]=e,localStorage.setItem(this.metadataKey,JSON.stringify(t))}},{key:"checkForIntersections",value:function(n){var i=this,e=JSON.parse(localStorage.getItem(this.metadataKey))||{};Object.entries(e).forEach(function(e){var e=s(e,2),t=e[0],e=e[1];t!==i.windowId&&i.isOverlapping(n,e)&&i.emitIntersectionEvent(t,i.calculateIntersection(n,e))})}},{key:"isOverlapping",value:function(e,t){return!(t.position.x>=e.position.x+e.size.width||t.position.x+t.size.width<=e.position.x||t.position.y>=e.position.y+e.size.height||t.position.y+t.size.height<=e.position.y)}},{key:"calculateIntersection",value:function(e,t){var n=Math.max(e.position.x,t.position.x),i=Math.max(e.position.y,t.position.y);return{position:{x:n,y:i},size:{width:Math.min(e.position.x+e.size.width,t.position.x+t.size.width)-n,height:Math.min(e.position.y+e.size.height,t.position.y+t.size.height)-i}}}},{key:"emitIntersectionEvent",value:function(e,t){this.channel.postMessage({action:"intersecting",sourceWindowId:this.windowId,targetWindowId:e,intersectionArea:t})}},{key:"sendMessage",value:function(e,t){console.log("postMessage message",e,t),this.channel.postMessage({action:"sendMessage",targetWindowId:e,payload:t})}},{key:"on",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}},{key:"emit",value:function(e,t){e=this.events[e];e&&e.forEach(function(e){e(t)})}},{key:"handleDirectMessage",value:function(e){console.log("Received direct message:",e),this.emit("message",e)}},{key:"open",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=2<arguments.length&&void 0!==arguments[2]&&arguments[2];if(e){var t=a(a({},{width:600,height:400,menubar:"no",toolbar:"no",location:"no",status:"no",scrollbars:"yes",resizable:"yes",title:(new Date).toISOString(),top:window.screenY+100,left:window.screenX+100}),t),i=(n&&(window.resizeTo(window.outerWidth/2,window.outerHeight/2),window.moveTo(t.left,t.top),t.width=window.outerWidth,t.height=window.outerHeight),Object.entries(t).map(function(e){var e=s(e,2),t=e[0],e=e[1];return"".concat(t,"=").concat(e)}).join(",")),e=window.open(e,t.title,i);if(e)return n&&e.moveTo(window.screenX+window.outerWidth,window.screenY),e;console.error("Failed to open a new window. Please check browser popup settings.")}else console.error("URL is required to open a new window.")}},{key:"registerWindow",value:function(){this.updateWindowMetadata(),this.pingOtherWindows()}},{key:"pingOtherWindows",value:function(){var e=this;this.channel.postMessage({action:"ping",sourceWindowId:this.windowId}),setTimeout(function(){e.removeInactiveWindows()},5e3)}},{key:"setupListeners",value:function(){var t=this;this.channel.onmessage=function(e){e=e.data;"createEntity"===e.action&&e.entities?e.entities.forEach(function(e){return t.game.createEntity(e)}):"ping"===e.action&&e.sourceWindowId!==t.windowId?t.channel.postMessage({action:"pong",sourceWindowId:t.windowId}):"pong"===e.action&&e.sourceWindowId!==t.windowId?t.markWindowAsActive(e.sourceWindowId):"sendMessage"===e.action&&e.targetWindowId===t.windowId?t.handleDirectMessage(e):"intersecting"===e.action&&e.sourceWindowId!==t.windowId&&t.emit("message",e)}}},{key:"markWindowAsActive",value:function(e){var t=JSON.parse(localStorage.getItem(this.metadataKey))||{};t[e]&&(t[e].lastActive=Date.now(),localStorage.setItem(this.metadataKey,JSON.stringify(t)))}},{key:"removeInactiveWindows",value:function(){var n=JSON.parse(localStorage.getItem(this.metadataKey))||{},i=Date.now();Object.entries(n).forEach(function(e){var e=s(e,2),t=e[0],e=e[1];5e3<i-e.lastActive&&delete n[t]}),localStorage.setItem(this.metadataKey,JSON.stringify(n))}},{key:"teleportEntities",value:function(t,e){var n=this.game.entities.filter(function(e){return t.includes(e.id)});0<n.length&&this.channel.postMessage({action:"createEntity",targetWindowId:e,entities:n})}},{key:"deregisterWindow",value:function(){var e=JSON.parse(localStorage.getItem(this.metadataKey))||{};delete e[this.windowId],localStorage.setItem(this.metadataKey,JSON.stringify(e))}},{key:"getBestWindow",value:function(n){var i=this,o=this.determineCardinalDirection(n.screenPosition),e=JSON.parse(localStorage.getItem(this.metadataKey))||{},r=(0===Object.keys(e).length&&game.flashMessage("no other windows found"),null),a=1/0;if(Object.entries(e).forEach(function(e){var e=s(e,2),t=e[0],e=e[1];(r=t)!==i.windowId&&(e=i.calculateDistance(n.screenPosition,e.position))<a&&(a=e,r=t)}),r)return{postMessage:function(e){console.log("calling internal bestWindow.postMessage",r,e);var t=i.calculateEntryPosition(o,e.position);e.position=t,console.log("SENDING NEW POST",e),i.channel.postMessage({action:"sendMessage",targetWindowId:r,payload:e})}};game.flashMessage("could not find any windows")}},{key:"calculateEntryPosition",value:function(e,t){return t.x=-100,t.y=0,t}},{key:"calculateDistance",value:function(e,t){var n=e.x-t.x,e=e.y-t.y;return Math.sqrt(n*n+e*e)}},{key:"determineCardinalDirection",value:function(e){var t=window.innerWidth/2,n=window.innerHeight/2;return e.x<t&&e.y<n?"NW":e.x>=t&&e.y<n?"NE":e.x>=t&&e.y>=n?"SE":e.x<t&&e.y>=n?"SW":void 0}},{key:"calculateWindowFeaturesForDirection",value:function(e){}}])&&c(e.prototype,t),n&&c(e,n),Object.defineProperty(e,"prototype",{writable:!1}),o}()},{}]},{},[1])(1)});
//# sourceMappingURL=crosswindow.min.js.map