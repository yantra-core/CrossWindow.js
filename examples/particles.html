<!DOCTYPE html>
<html>

<head>
  <title>CrossWindow.js Demo</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A Javascript utility library for cross-window communication">
  <script src="./mantra.js"></script>
  <script src="./worlds.mantra.js"></script>
  <script src="./crosswindow.js"></script>
  <script src="./crosswindow.debugger.js"></script>

  <style>
    .main {
      position: relative;
      /* Makes .main the reference for absolutely positioned children */
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      flex-direction: column;
      color: white;
      top: 20%;
      overflow: auto;
    }

    .main a {
      font-size: 24px;
      color: white
    }

    .links div {
      padding: 0.4em;
    }

    .help {
      /* should appear at the bottom 30% of screen */
      position: relative;
      top: 100px;
      padding: 1em;
    }

    button {
      position: absolute;
      padding: 0.3em;
      font-size: 1.5em;
      height: 3em;
      /* Responsive font size */
      cursor: pointer;
      z-index: 9999;
      transition: background-color 0.2s;
      /* Smooth transition for hover effect */
    }

    button:hover {
      background-color: rgba(255, 255, 255, 0.2);
      /* Change background on hover */
    }

    #openWindowButtons {
      position: absolute;
      top: 10px;
      right: 160px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      padding: 0.5em;
      background-color: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .switchExample a {
      z-index: 9999;
      padding: 0.5em;
      font-size: 1em;
    }
  </style>
</head>

<body>

  <script>
    // Utility functions
    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints;
    }
  
    function getRandomColor(exclude) {
      const royGBiv = ['#FF0000', '#FFA500', '#FFFF00', '#008000', '#0000FF', '#4B0082', '#EE82EE'];
      const filtered = royGBiv.filter(color => color !== exclude);
      return filtered[Math.floor(Math.random() * filtered.length)];
    }
  
    function particleCollisionHandler(a, b, pair, context) {
      if (context.target.type === 'PARTICLE' && pair.isActive !== false) {
        const colorA = context.target.color;
        const colorB = context.owner.color;
        if (colorA !== colorB) {
          game.removeEntity(context.target.id);
          const mixed = mixColors(colorA, colorB);
          game.updateEntity(context.owner.id, {
            color: mixed,
            size: { width: context.owner.size.width * 1.1, height: context.owner.size.height * 1.1 }
          });
        }
        pair.isActive = false; // Cancel the collision
      }
    }
  
    function mixColors(colorA, colorB) {
      // This function should implement color mixing logic
      const mixedColor = '#FFFFFF'; // Placeholder for mixed color calculation
      console.log('colorA', colorA, 'colorB', colorB, 'mixed', mixedColor);
      return mixedColor;
    }
  
    function setupEventListeners() {
      document.getElementById('changeColor').addEventListener('change', event => {
        color = event.target.value;
        updateEntitiesColor(color);
      });
  
      document.querySelectorAll('#openWindowButtons button').forEach(button => {
        button.addEventListener('click', () => openNewWindow(color));
      });
    }
  
    function updateEntitiesColor(color) {
      game.flashMessage(color);
      ['fountA', 'fountB'].forEach(fountName => {
        const fount = game.getEntityByName(fountName);
        game.updateEntity(fount.id, { color: color, ...(fountName === 'fountA' && { metadata: { unitConfig: { color: color } } }) });
      });
    }
  
    function openNewWindow(color) {
      const windowWidth = window.innerWidth;
      const windowHeight = window.outerHeight - 75;
      const left = window.screenX + window.outerWidth;
      game.systems.crosswindow.crosswindow.open(`particles.html?win=${color}`, {
        width: windowWidth, height: windowHeight, top: window.screenY, left: left
      }, true);
    }
  
    // Initialization and game setup
    document.addEventListener('DOMContentLoaded', () => {
      if (isTouchDevice()) {
        alert('Please note CrossWindow multi-window demo is not optimized for touch devices.');
      }
  
      if (window.location.search.includes('win')) {
        document.querySelector('.main')?.remove();
      }
  
      let color = getRandomColor(window.location.search);
  
      let game = new MANTRA.Game({
        graphics: ['css'],
        plugins: ['UnitSpawner', 'GravityWell', 'Player', 'Draggable', 'Hexapod', 'Tower', 'RBush', 'Key', 'Block', 'Collectable', 'Teleporter', 'Gamepad', 'Bullet'],
        width: 400, height: 300, warnNonYantraGameRoot: false, disableContextMenu: false, gameRoot: 'http://192.168.1.80:7777'
      });
  
      configureGame(game);
      setupEventListeners();
      initializeEntities(game, color);
    });
  
    function configureGame(game) {
      game.use('CrossWindow', { debugger: { showExampleBarContainer: true } });
      game.config.emitKeyboardInputsEvents = true;
      game.config.entityEmitsViewportExitEvent = true;
      game.config.mouseMovementButton = 'LEFT';
      game.config.mouseActionButton = 'RIGHT';
      game.use('Bullet');
      window.game = game; // Expose game globally
    }
  
    function initializeEntities(game, color) {
      game.start(() => {
        game.setBackground('black');
        createFountains(game, color);
        createGravityWells(game);
        handleSubWindowLogic(game);
      });
    }
  
    function createFountains(game, color) {
      ['fountA', 'fountB'].forEach((name, index) => {
        game.make()
          .name(name)
          .type('FOUNT')
          .UnitSpawner({
            unitConfig: {
              type: 'PARTICLE',
              color: color,
              size: { width: 8, height: 8 },
              friction: 0, frictionStatic: 0, frictionAir: 0,
              position: { x: index ? 200 : -200, y: 0 },
              sprayAngle: index ? 0 : Math.PI,
              collisionStart: particleCollisionHandler
            }
          })
          .color(color)
          .isStatic(true)
          .size(8, 8)
          .position(index ? 50 : -50, 0)
          .createEntity();
      });
    }
  
    function createGravityWells(game) {
      const gwConfig = game.make().GravityWell().color('red').size(4).isStatic(true).isSensor(true);
      gwConfig.position(0, -100).createEntity();
      gwConfig.position(0, 100).createEntity();
    }
  
    function handleSubWindowLogic(game) {
      if (!window.location.search.includes('win')) {
        const currentPlayer = game.make().Player().isSensor().createEntity();
        const globalPosition = { x: currentPlayer.position.x - window.screenX, y: currentPlayer.position.y - window.screenY };
        game.updateEntity(currentPlayer.id, { meta: { equippedItems: [{ plugin: 'bullet', method: 'fireBullet' }] } });
        localStorage.setItem('mantra-currentPlayer', JSON.stringify(globalPosition));
        if (game.systems.hexapod) {
          game.systems.hexapod.setTarget(globalPosition);
        }
      }
    }
  
  </script>
  
  <div id="openWindowButtons">
    <button>Open Window</button>
  </div>

  <div class="main">

    <div>
      <h1>CrossWindow.js + Mantra.js</h1>
    </div>
    <div class="links">
      <div>
        <a href="https://github.com/yantra-core/CrossWindow.js">Github Source</a>
      </div>
      <div class="switchExample">
        <a href="https://yantra.gg/crosswindow/simple">Switch to Simple Example</a>
      </div>

    </div>
    <!-- let royGBivHex = ['#FF0000', '#FFA500', '#FFFF00', '#008000', '#0000FF', '#4B0082', '#EE82EE']; -->
    <select id="changeColor">
      <option value="#FF0000">Red</option>
      <option value="#FFA500">Orange</option>
      <option value="#FFFF00">Yellow</option>
      <option value="#008000">Green</option>
      <option value="#0000FF">Blue</option>
      <option value="#4B0082">Indigo</option>
      <option value="#EE82EE">Violet</option>
    </select>
  </div>

</body>

</html>