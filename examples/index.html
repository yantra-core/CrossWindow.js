<!DOCTYPE html>
<html>

<head>
  <title>CrossWindow.js Demo</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="A Javascript utility library for cross-window communication">
  <script src="./mantra.js"></script>
  <script src="./crosswindow.js"></script>
  <script src="./crosswindow.debugger.js"></script>

  <style>
    .main {
      position: relative;
      /* Makes .main the reference for absolutely positioned children */
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      flex-direction: column;
      color: white;
      top: 20%;
      overflow: auto;
    }

    .main a {
      font-size: 24px;
      color: white
    }

    .links div {
      padding: 0.4em;
    }

    .help {
      /* should appear at the bottom 30% of screen */
      position: relative;
      top: 100px;
      padding: 1em;
    }


    .switchExample a {
      z-index: 9999;
      padding: 0.5em;
      font-size: 1em;
    }
  </style>
</head>

<body>

  <script>


    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints;
    }

    document.addEventListener('DOMContentLoaded', (event) => {

      if (isTouchDevice()) {
        alert('Please note CrossWindow multi-window demo is not optimized for touch devices.');
      }

      // when click helpLabel toggle background visibility
      document.querySelector('.helpLabel').addEventListener('click', function () {
        let main = document.querySelector('.main');
        main.style.display = 'none';
      });

      document.querySelectorAll('#openWindowButtons button').forEach(button => {
        button.addEventListener('click', function () {
          const windowWidth = window.innerWidth;
          const windowHeight = window.outerHeight - 75;
          const offsetX = window.screenX; // Current window's distance from the left edge of the screen
          const offsetY = window.screenY; // Current window's distance from the top edge of the screen
          let buffer = 10; // Define a buffer distance for the new window
          let top = offsetY, left = offsetX;

          //console.log('top', top, 'left', left);

          // Open new window with calculated top and left positions
          crosswindow.open('index.html?win', {
            width: windowWidth,
            height: windowHeight,
            top: top /*- window.outerHeight*/,
            left: left + window.outerWidth,
          }, true);
        });
      });

      let game = new MANTRA.Game({
        graphics: ['css'], // array enum, 'babylon', 'css', 'three'
        // Plugins at construction
        plugins: ['Player', 'CrossWindow', 'Hexapod', 'Tower', 'RBush', 'Key', 'Block', 'Collectable', 'Teleporter', 'Gamepad', 'Bullet'],
        width: 400,
        height: 300,
        warnNonYantraGameRoot: true,
        disableContextMenu: false,
        gameRoot: 'http://192.168.1.80:7777'
      });

      game.config.emitKeyboardInputsEvents = true;
      window.game = game;
      game.config.entityEmitsViewportExitEvent = true;

      // Movements with right click, switch default left-click-to-move behavior
      game.config.mouseMovementButton = 'LEFT';
      // Actions with left click
      game.config.mouseActionButton = 'RIGHT';

      game.use('Bullet'); // plugins at runtime
   
      game.start(function () {
    
        game.setBackground('#000000');

        let currentWindows = game.systems.crosswindow.crosswindow.getWindows();

        // check if 'win' exists as query string variable, if no, so player
        // if not, create player
        let isSubWindow = window.location.search.includes('win');
        if (!isSubWindow) {
          let currentPlayer = game.make().Player().createEntity();
          // set currentPlayer in localStorage so Hexapods can track it cross window
          let globalPosition = {
            x: currentPlayer.position.x - window.screenX,
            y: currentPlayer.position.y - window.screenY
          };

          // TODO: make this a mantra helper
          game.updateEntity(currentPlayer.id, {
            meta: {
              equippedItems: [{
                plugin: 'bullet',
                method: 'fireBullet'
              }]
            }
          });

          console.log('saving global', globalPosition);
          localStorage.setItem('mantra-currentPlayer', JSON.stringify(globalPosition));
          // update target
          if (game.systems.hexapod) {
            game.systems.hexapod.setTarget(globalPosition);
          }
          /*
          for (let i = 0; i < 1; i++) {
          let randomRadial = game.radialSpread(0, 0, 100, 1, i);
            setTimeout(function(){
              game.make().Key({
              position: randomRadial
            }).body(true).createEntity();
          }, 30000)
                  }

          */

        } else {

          let savedPlayer = JSON.parse(localStorage.getItem('mantra-currentPlayer'));

          // alert(localStorage.getItem('mantra-currentPlayer'));

          let target = null;
          if (savedPlayer) {
            target = savedPlayer;
          }
          game.make().Hexapod({
            target: savedPlayer
          }).repeat(6).createEntity();
        }

      });

    });

  </script>

  <div class="main">

    <div>
      <h1>CrossWindow.js + Mantra.js</h1>
    </div>
    <div class="links">
      <div>
        <a href="https://github.com/yantra-core/CrossWindow.js">Github Source</a>
      </div>
      <div class="switchExample">
        <a href="https://yantra.gg/crosswindow/simple">Switch to Simple Example</a>
      </div>

    </div>
    <div class="help">

      <h3>

        <label class="helpLabel" for="hideHelp" title="Hides helper text">Help
          <input type="checkbox" id="hideHelp" checked />
        </label>

      </h3>
      <p>Click the top-right button to open a new CrossWindow<br />
        Each new CrossWindow will have its own Mantra.js game instance<br />
        Move between windows by travelling to the edge of the screen<br />
      </p>
      <h3>Controls</h3>
      <p>
        WASD to move the player<br />
        LEFT MOUSE TO MOVE - RIGHT MOUSE TO SHOOT<br />
        USB GAMEPAD SUPPORTED
      </p>
    </div>

  </div>

</body>

</html>